import { GameState, Unit } from '../engine/types';
import { IEffect } from './types';
import { Element, StatKey } from '@/app/types';

export interface VulnerabilityEffect extends IEffect {
    element: Element; // 脆弱属性
    amount: number; // 脆弱量（0.25 = 25%）
}

/**
 * 属性別脆弱デバフエフェクトを作成
 * @param source 発生源ユニット
 * @param target 対象ユニット
 * @param element 脆弱属性
 * @param amount 脆弱量（例: 0.25 = 25%）
 * @param duration 持続ターン数
 */
export function createVulnerabilityEffect(
    source: Unit,
    target: Unit,
    element: Element,
    amount: number,
    duration: number
): IEffect {
    // 属性に対応する脆弱キーを取得（例: 'fire_vuln', 'ice_vuln'）
    const vulnKey = `${element.toLowerCase()}_vuln` as StatKey;

    return {
        id: `vuln-${element}-${source.id}-${target.id}-${Date.now()}`,
        name: `${element}脆弱`,
        category: 'DEBUFF',
        sourceUnitId: source.id,
        durationType: 'TURN_END_BASED',
        skipFirstTurnDecrement: true,
        duration: duration,

        // モディファイアで脆弱を定義（NEW）
        modifiers: [{
            target: vulnKey,
            source: `${element}脆弱`,
            type: 'add',
            value: amount
        }],

        // apply/removeは空関数に（statBuilderが自動処理）
        isCleansable: true,  // 解除可能なデバフ
        apply: (t, s) => s,
        remove: (t, s) => s
    };
}

/**
 * 全属性脆弱デバフエフェクトを作成
 * @param source 発生源ユニット
 * @param target 対象ユニット
 * @param amount 脆弱量（例: 0.10 = 10%）
 * @param duration 持続ターン数
 */
export function createAllTypeVulnerabilityEffect(
    source: Unit,
    target: Unit,
    amount: number,
    duration: number
): IEffect {
    return {
        id: `vuln-all-${source.id}-${target.id}-${Date.now()}`,
        name: `全属性脆弱`,
        category: 'DEBUFF',
        sourceUnitId: source.id,
        durationType: 'TURN_END_BASED',
        skipFirstTurnDecrement: true,
        duration: duration,

        // モディファイアで脆弱を定義（NEW）
        modifiers: [{
            target: 'all_type_vuln',
            source: '全属性脆弱',
            type: 'add',
            value: amount
        }],

        // apply/removeは空関数に（statBuilderが自動処理）
        isCleansable: true,  // 解除可能なデバフ
        apply: (t, s) => s,
        remove: (t, s) => s
    };
}
